<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>نقشه فریلنسرها و بانک‌های سامان در ایران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- آیکون‌ها -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <!-- Excel Reader -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    /* تمام CSS شما بدون تغییر */
    /* همان کدی که فرستادی */
  </style>
</head>
<body>

  <!-- UI آپلود فایل و راهنما -->
  <div class="upload-container">
    <div class="upload-header">
      <i class="fas fa-map-marked-alt"></i>
      <h3>نقشه فریلنسرها و بانک‌های سامان</h3>
    </div>
    <label for="fileInput" class="custom-file-upload">
      <i class="fas fa-file-upload"></i>
      <p>فایل اکسل خود را اینجا رها کنید یا کلیک کنید</p>
      <small>فرمت مورد قبول: XLSX, XLS</small>
    </label>
    <input type="file" id="fileInput" accept=".xlsx, .xls" />
  </div>

  <div id="map"></div>

  <div class="legend">
    <h3>راهنما</h3>
    <div class="legend-item">
      <span class="legend-color" style="background-color: #2ecc71;"></span>
      <span>تراکم کم فریلنسرها</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background-color: #f39c12;"></span>
      <span>تراکم متوسط فریلنسرها</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background-color: #e74c3c;"></span>
      <span>تراکم زیاد فریلنسرها</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background-color: #9b59b6;"></span>
      <span>بانک‌های سامان</span>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // تعریف نقشه با مرکز ایران
      var map = L.map('map').setView([32.4279, 53.6880], 5);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // آیکون سفارشی بانک سامان
      var bankIcon = L.divIcon({
        className: 'bank-icon',
        html: '<div style="background-color: #9b59b6; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-university" style="font-size: 14px;"></i></div>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      // لیست شعب بانک سامان
      var samanBanks = [
        { city: "تهران", lat: 35.6892, lng: 51.3890, name: "شعبه مرکزی", address: "خیابان ولیعصر، نرسیده به میدان ولیعصر" },
        { city: "اصفهان", lat: 32.6539, lng: 51.6660, name: "شعبه اصفهان", address: "میدان امام حسین، ابتدای چهارباغ بالا" },
        { city: "مشهد", lat: 36.2605, lng: 59.6168, name: "شعبه مشهد", address: "بلوار احمدآباد، نبش احمدآباد 10" },
        { city: "تبریز", lat: 38.0962, lng: 46.2738, name: "شعبه تبریز", address: "خیابان امام خمینی، جنب بازار تبریز" },
        { city: "شیراز", lat: 29.5926, lng: 52.5836, name: "شعبه شیراز", address: "بلوار کریمخان زند، نبش کوچه 10" },
        { city: "کرج", lat: 35.8400, lng: 50.9391, name: "شعبه کرج", address: "میدان شهدا، جنب شهرداری کرج" },
        { city: "قم", lat: 34.6399, lng: 50.8764, name: "شعبه قم", address: "بلوار امین، روبروی حرم حضرت معصومه" },
        { city: "اهواز", lat: 31.3183, lng: 48.6706, name: "شعبه اهواز", address: "خیابان ساحلی، جنب پارک دولت" },
        { city: "کرمان", lat: 30.2839, lng: 57.0833, name: "شعبه کرمان", address: "بلوار جمهوری، نبش خیابان شریعتی" },
        { city: "ارومیه", lat: 37.5522, lng: 45.0749, name: "شعبه ارومیه", address: "خیابان امام، جنب بازار روز ارومیه" }
      ];

      // افزودن مارکر بانک‌ها
      samanBanks.forEach(function (bank) {
        L.marker([bank.lat, bank.lng], {
          icon: bankIcon,
          riseOnHover: true
        }).addTo(map).bindPopup(`
          <div class="popup-header">
            <i class="fas fa-university"></i> ${bank.name} بانک سامان
          </div>
          <div class="popup-content">
            <strong>شهر:</strong> ${bank.city}<br>
            <strong>آدرس:</strong> ${bank.address}<br><br>
            <i class="fas fa-phone" style="color: #3498db;"></i> 021-12345678
          </div>
        `);
      });

      // تابع رنگ‌بندی بر اساس تعداد فریلنسرها
      function getColorByCount(count) {
        if (count < 10) return '#2ecc71';
        if (count < 20) return '#f39c12';
        return '#e74c3c';
      }

      // اکسل خوانی
      document.getElementById('fileInput').addEventListener('change', function (e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();

        reader.onload = function (e) {
          try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            var jsonData = XLSX.utils.sheet_to_json(firstSheet);

            map.eachLayer(function (layer) {
              if (layer instanceof L.Circle) {
                map.removeLayer(layer);
              }
            });

            var maxCount = Math.max(...jsonData.map(item => item.count || item.Count || item.تعداد || 1));

            jsonData.forEach(function (item) {
              var city = item.city || item.City || item.شهر;
              var count = item.count || item.Count || item.تعداد;
              var lat = item.lat || item.Lat || item.عرض_جغرافیایی;
              var lng = item.lng || item.Lng || item.طول_جغرافیایی;

              if (city && count && lat && lng) {
                var radius = (count / maxCount) * 10000 + 2000;

                L.circle([lat, lng], {
                  color: '#fff',
                  fillColor: getColorByCount(count),
                  fillOpacity: 0.7,
                  weight: 1,
                  radius: radius
                }).addTo(map).bindPopup(`
                  <div class="popup-header">
                    <i class="fas fa-users"></i> ${city}
                  </div>
                  <div class="popup-content">
                    <strong>تعداد فریلنسرها:</strong> ${count}<br>
                    <strong>موقعیت:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}
                  </div>
                `);
              }
            });

            alert(`داده‌های ${jsonData.length} شهر با موفقیت بارگذاری شدند.`);
          } catch (err) {
            console.error(err);
            alert('خطا در پردازش فایل اکسل. لطفاً فایل را بررسی کنید.');
          }
        };

        reader.readAsArrayBuffer(file);
      });

      // جستجوی موقعیت
      L.Control.geocoder({
        defaultMarkGeocode: false,
        position: 'topleft',
        placeholder: 'جستجوی شهر یا مکان...',
        errorMessage: 'مکانی یافت نشد.',
        showResultIcons: true,
        collapseAfterResult: false,
        expand: 'click'
      }).on('markgeocode', function (e) {
        map.fitBounds(e.geocode.bbox);
        L.marker(e.geocode.center).addTo(map)
          .bindPopup(e.geocode.name)
          .openPopup();
      }).addTo(map);

      // کنترل زوم
      L.control.zoom({ position: 'topright' }).addTo(map);

      // دراگ اند دراپ
      var uploadContainer = document.querySelector('.upload-container');
      var fileInput = document.getElementById('fileInput');

      uploadContainer.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadContainer.style.boxShadow = '0 0 25px rgba(52, 152, 219, 0.5)';
      });

      uploadContainer.addEventListener('dragleave', function (e) {
        e.preventDefault();
        uploadContainer.style.boxShadow = '0 0 20px rgba(0, 0, 0, 0.2)';
      });

      uploadContainer.addEventListener('drop', function (e) {
        e.preventDefault();
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          var event = new Event('change');
          fileInput.dispatchEvent(event);
        }
      });
    });
  </script>
</body>
</html>

